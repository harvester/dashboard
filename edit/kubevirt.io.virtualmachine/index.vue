<script>
import isEqual from 'lodash/isEqual';
import cloneDeep from 'lodash/cloneDeep';
import { mapGetters } from 'vuex';
import { safeDump } from 'js-yaml';

import Banner from '@/components/Banner';
import Tabbed from '@/components/Tabbed';
import Tab from '@/components/Tabbed/Tab';
import Checkbox from '@/components/form/Checkbox';
import CruResource from '@/components/CruResource';
import RadioGroup from '@/components/form/RadioGroup';
import LabeledInput from '@/components/form/LabeledInput';
import LabeledSelect from '@/components/form/LabeledSelect';
import NameNsDescription from '@/components/form/NameNsDescription';

import SSHKey from '@/edit/kubevirt.io.virtualmachine/SSHKey';
import Volume from '@/edit/kubevirt.io.virtualmachine/volume';
import Network from '@/edit/kubevirt.io.virtualmachine/network';
import ImageSelect from '@/edit/kubevirt.io.virtualmachine/Image';
import CpuMemory from '@/edit/kubevirt.io.virtualmachine/CpuMemory';
import CloudConfig from '@/edit/kubevirt.io.virtualmachine/CloudConfig';

import { HCI } from '@/config/types';
import { cleanForNew } from '@/plugins/steve/normalize';
import { HCI as HCI_ANNOTATIONS } from '@/config/labels-annotations';

import VM_MIXIN from '@/mixins/vm';
import CreateEditView from '@/mixins/create-edit-view';

export default {
  name: 'EditVM',

  components: {
    Tab,
    Tabbed,
    Banner,
    Checkbox,
    RadioGroup,
    CruResource,
    LabeledInput,
    LabeledSelect,
    NameNsDescription,
    Volume,
    SSHKey,
    Network,
    CpuMemory,
    ImageSelect,
    CloudConfig,
  },

  mixins: [CreateEditView, VM_MIXIN],

  props: {
    value: {
      type:     Object,
      required: true,
    },
  },

  data() {
    const cloneDeepVM = cloneDeep(this.value);
    const isRestartImmediately = this.value.actualState === 'Running';

    return {
      cloneDeepVM,
      count:                 2,
      realHostname:          '',
      templateId:            '',
      templateVersionId:       '',
      isSingle:              true,
      isRunning:             true,
      useTemplate:           false,
      isRestartImmediately,
    };
  },

  computed: {
    ...mapGetters({ t: 'i18n/t' }),

    machineTypeOptions() {
      return [{
        label: 'None',
        value: ''
      }, {
        label: 'q35',
        value: 'q35'
      }, {
        label: 'pc',
        value: 'pc'
      }];
    },

    templateOptions() {
      return this.templates.map( (T) => {
        return {
          label: T.id,
          value: T.id
        };
      });
    },

    versionOptions() {
      const defaultVersion = this.curTemplateResource?.defaultVersion;

      return this.versions.filter( O => O.templateId === this.templateId).map( (T) => {
        const version = T.version;

        const label = defaultVersion === version ? `${ version } (${ this.t('generic.default') })` : version;
        const value = T.id;

        return { label, value };
      });
    },

    curTemplateResource() {
      return this.templates.find( O => O.id === this.templateId);
    },

    curVersionResource() {
      return this.versions.find( O => O.id === this.templateVersionId);
    },

    nameLabel() {
      return this.isSingle ? 'harvester.virtualMachine.instance.single.nameLabel' : 'harvester.virtualMachine.instance.multiple.nameLabel';
    },

    hostnameLabel() {
      return this.isSingle ? 'harvester.virtualMachine.instance.single.host.label' : 'harvester.virtualMachine.instance.multiple.host.label';
    },

    hostPlaceholder() {
      return this.isSingle ? this.t('harvester.virtualMachine.instance.single.host.placeholder') : this.t('harvester.virtualMachine.instance.multiple.host.placeholder');
    },

    hostname: {
      get() {
        return this.spec.template.spec?.hostname;
      },

      set(neu) {
        if (neu) {
          this.$set(this.spec.template.spec, 'hostname', neu);
        }
      }
    },
  },

  watch: {
    templateId(id) {
      if (!id) {
        return;
      }

      this.templateVersionId = this.templates.find( O => O.id === id)?.defaultVersionId;
    },

    templateVersionId(id) {
      if (!id) {
        return;
      }
      const curVersion = this.versions.find( V => V.id === id);
      const sshKey = curVersion.spec?.keyPairIds || [];

      const cloudScript = curVersion?.spec?.vm?.template?.spec?.volumes?.find( (V) => {
        return V.cloudInitNoCloud !== undefined;
      })?.cloudInitNoCloud; // TODO: use modals

      this.$set(this, 'userScript', cloudScript?.userData);
      this.$set(this, 'networkScript', cloudScript?.networkData);
      this.$set(this, 'sshKey', sshKey);
      // this.$refs.ssh.updateSSH(sshKey);
      this.value.spec = curVersion?.spec?.vm;
      this.changeSpec();
    },

    useTemplate(neu) {
      if (neu === false) {
        this.templateId = '';
        this.templateVersionId = '';
        this.value.applyDefaults();
        this.changeSpec();
      }
    },

    installAgent(neu) {
      let parsed = {};

      if (neu) {
        parsed = this.mergeGuestAgent(cloneDeep(this.userScript));
      } else {
        parsed = this.deleteGuestAgent(cloneDeep(this.userScript));
      }
      let out = safeDump(parsed);

      if (parsed === '') {
        out = undefined;
      }

      this.$set(this, 'userScript', out);
    },
  },

  created() {
    this.registerBeforeHook(() => {
      Object.assign(this.value.metadata.labels, {
        ...this.value.metadata.labels,
        [HCI_ANNOTATIONS.CREATOR]: 'harvester',
      });

      Object.assign(this.value.spec.template.metadata.annotations, {
        ...this.value.spec.template.metadata.annotations,
        [HCI_ANNOTATIONS.SSH_NAMES]: JSON.stringify(this.sshKey)
      });

      Object.assign(this.value.metadata.annotations, {
        ...this.value.metadata.annotations,
        [HCI_ANNOTATIONS.NETWORK_IPS]: JSON.stringify(this.value.networkIps)
      });
    });

    this.registerFailureHook(() => { // Creating a VM doesn't need type, but the frontend needs to find resources according to type.
      this.$set(this.value, 'type', HCI.VM);
    });

    this.registerAfterHook(() => { // may need to restart VM when editing
      if ( this.mode === 'edit' && this.value.hasAction('restart')) {
        const cloneDeepNewVM = cloneDeep(this.value);

        delete cloneDeepNewVM.type;
        delete cloneDeepNewVM?.metadata;
        delete this.cloneDeepVM.type;
        delete this.cloneDeepVM?.metadata;

        const dataVolumeTemplates = this.cloneDeepVM?.spec?.dataVolumeTemplates || [];

        for (let i = 0; i < dataVolumeTemplates.length; i++) {
          delete this.cloneDeepVM.spec.dataVolumeTemplates[i]?.metadata?.creationTimestamp;
        }

        const oldValue = JSON.parse(JSON.stringify(this.cloneDeepVM));
        const newValue = JSON.parse(JSON.stringify(cloneDeepNewVM));

        if (!isEqual(oldValue, newValue) && this.isRestartImmediately) {
          this.value.doAction('restart', {});
        }
      }
    });
  },

  mounted() {
    this.imageId = this.$route.query?.image || this.imageId;

    const templateId = this.$route.query.templateId;
    const templateVersionId = this.$route.query.versionId;

    if (templateId && templateVersionId) {
      this.templateId = templateId;
      this.templateVersionId = templateVersionId;
      this.useTemplate = true;
    }
  },

  methods: {
    saveVM(buttonCb) {
      if (this.isSingle) {
        this.saveSingle(buttonCb);
      } else {
        this.saveMultiple(buttonCb);
      }
    },

    async saveSingle(buttonCb) {
      this.normalizeSpec();

      if (!this.value.spec.template.spec.hostname) {
        this.$set(this.value.spec.template.spec, 'hostname', this.value.metadata.name);
      }

      await this.save(buttonCb);
    },

    async saveMultiple(buttonCb) {
      const namePrefix = this.value.metadata.name || '';
      const baseHostname = this.value?.spec?.template?.spec?.hostname ? this.value.spec.template.spec.hostname : this.value.metadata.name;
      const join = namePrefix.endsWith('-') ? '' : '-';

      if (this.count < 1) {
        this.errors = [this.t('harvester.virtualMachine.instance.multiple.countTip')];
        buttonCb(false);

        return;
      }

      for (let i = 1; i <= this.count; i++) {
        this.$set(this.value, 'type', HCI.VM);

        const suffix = i < 10 ? `0${ i }` : i;

        cleanForNew(this.value);
        this.value.metadata.name = `${ namePrefix }${ join }${ suffix }`;
        const hostname = `${ baseHostname }${ join }${ suffix }`;

        this.$set(this.value.spec.template.spec, 'hostname', hostname);

        this.normalizeSpec();

        try {
          await this.save(buttonCb);
        } catch (err) {
          return Promise.reject(new Error(err));
        }
      }
      this.value.id = '';
    },

    changeSpec() {
      const spec = this.value.spec;
      const diskRows = this.getDiskRows(spec);
      const networkRows = this.getNetworkRows(spec);
      const imageId = this.getRootImageId(spec);

      if (imageId) {
        this.autoChangeForImage = false;
      }

      this.$set(this, 'spec', spec);
      this.$set(this, 'diskRows', diskRows);
      this.$set(this, 'networkRows', networkRows);
      this.$set(this, 'imageId', imageId);
    },

    validataCount(count) {
      if (count > 10) {
        this.$set(this, 'count', 10);
      }
    },

    updateCpuMemory(cpu, memory) {
      this.$set(this.spec.template.spec.domain.cpu, 'cores', cpu);
      this.$set(this, 'memory', memory);
    },

    onTabChanged({ tab }) {
      if (tab.name === 'advanced' && this.$refs.yamlEditor?.refresh) {
        this.$refs.yamlEditor.refresh();
      }
    },
  },
};
</script>

<template>
  <div id="vm">
    <CruResource
      :done-route="doneRoute"
      :resource="value"
      :can-yaml="false"
      :mode="mode"
      :errors="errors"
      @apply-hooks="applyHooks"
      @finish="saveVM"
    >
      <RadioGroup
        v-if="isCreate"
        v-model="isSingle"
        class="mb-20"
        name="createInstanceMode"
        :options="[true,false]"
        :labels="[t('harvester.virtualMachine.instance.single.label'), t('harvester.virtualMachine.instance.multiple.label')]"
      />

      <NameNsDescription
        v-model="value"
        :mode="mode"
        :has-extra="!isSingle"
        :name-label="nameLabel"
        :namespaced="true"
        :name-placeholder="isSingle ? 'nameNsDescription.name.placeholder' : 'harvester.virtualMachine.instance.multiple.nameNsDescription'"
        :extra-columns="isSingle ? [] :['type']"
      >
        <template v-slot:type>
          <LabeledInput
            v-if="!isSingle"
            v-model.number="count"
            v-int-number
            type="number"
            :label="t('harvester.virtualMachine.instance.multiple.count')"
            required
            @input="validataCount"
          />
        </template>
      </NameNsDescription>

      <Checkbox
        v-if="isCreate"
        v-model="useTemplate"
        class="check mb-20"
        type="checkbox"
        label-key="harvester.virtualMachine.useTemplate.label"
      />

      <div v-if="useTemplate" class="row mb-20">
        <div class="col span-6">
          <LabeledSelect
            v-model="templateId"
            label-key="harvester.virtualMachine.useTemplate.template.label"
            :options="templateOptions"
          />
        </div>

        <div class="col span-6">
          <LabeledSelect
            v-model="templateVersionId"
            label-key="harvester.virtualMachine.useTemplate.version.label"
            :options="versionOptions"
          />
        </div>
      </div>

      <Tabbed :side-tabs="true" @changed="onTabChanged">
        <Tab name="Basics" :label="t('harvester.virtualMachine.detail.tabs.basics')">
          <CpuMemory :cpu="spec.template.spec.domain.cpu.cores" :memory="memory" @updateCpuMemory="updateCpuMemory" />

          <ImageSelect v-model="imageId" class="mb-20" :disk-rows="diskRows" :disabled="!isCreate" />

          <SSHKey v-model="sshKey" class="mb-20" :namespace="value.metadata.namespace" @update:sshKey="updateSSHKey" />
        </Tab>

        <Tab
          name="Volume"
          :label="t('harvester.tab.volume')"
          :weight="-1"
        >
          <Volume v-model="diskRows" :mode="mode" :custom-volume-mode="customVolumeMode" />
        </Tab>

        <Tab
          name="Network"
          :label="t('harvester.tab.network')"
          :weight="-2"
        >
          <Network v-model="networkRows" :mode="mode" />
        </Tab>

        <Tab
          name="advanced"
          :label="t('harvester.tab.advanced')"
          :weight="-3"
        >
          <div class="row mb-20">
            <div class="col span-6">
              <LabeledInput
                v-model="hostname"
                :label-key="hostnameLabel"
                :placeholder="hostPlaceholder"
                required
              />
            </div>

            <div class="col span-6">
              <LabeledSelect
                v-model="machineType"
                label-key="harvester.virtualMachine.input.MachineType"
                :options="machineTypeOptions"
              />
            </div>
          </div>

          <CloudConfig
            ref="yamlEditor"
            :user-script="userScript"
            :mode="mode"
            :network-script="networkScript"
            @updateCloudConfig="updateCloudConfig"
          />

          <Checkbox v-model="isUseMouseEnhancement" class="check mt-20" type="checkbox" label-key="harvester.virtualMachine.enableUsb" />

          <Checkbox v-model="installAgent" class="check" type="checkbox" label-key="harvester.virtualMachine.installAgent" />
        </Tab>
      </Tabbed>

      <div class="mt-20">
        <Checkbox
          v-if="!isEdit"
          v-model="isRunning"
          class="check mb-20"
          type="checkbox"
          label-key="harvester.virtualMachine.createRunning"
        />

        <span v-if="isEdit" class="restart">
          <Banner color="warning" class="banner-right">
            {{ t('harvester.virtualMachine.restartTip') }}

            <Checkbox
              v-model="isRestartImmediately"
              class="check ml-20"
              type="checkbox"
              label-key="harvester.virtualMachine.restartNow"
            />
          </Banner>
        </span>
      </div>
    </CruResource>
  </div>
</template>

<style lang="scss" scoped>
#vm {
  ::v-deep .radio-group {
    display: flex;
    .radio-container {
      margin-right: 30px;
    }
  }

  .restart {
    display: flex;
    justify-content: flex-end;
  }

  .banner-right {
    width: auto;
    display: flex;
    justify-items: center;
  }
}
</style>
